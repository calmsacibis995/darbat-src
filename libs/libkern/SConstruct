Import("*")
import os
# -w flag is hack
# fix up .s files
srcList = src_glob("c++/*.cpp") + \
                  src_glob("c++/*.c") + src_glob("gen/*.c") + \
		  src_glob("gen/*.cpp") + \
		  src_glob("i386/OSAtomic.S") 
		  #src_glob("libsa//*.cpp") + src_glob("libsa/*.c")
		  #src_glob("kmod/*.c")	not needed??
#this whole list of cflags is a hack.
#needs libsa, so we pick up the KLDBootStrap constructor.
cxxflags=["-DYYMAXDEPTH=0",	# correct???
	"-DYYDEBUG=1",
	"-DXNU_KERNEL_PRIVATE=1",
	"-DMACH_ASSERT=0",
	"-DMACH_LDEBUG=0",
	"-D__LITTLE_ENDIAN__=1",
	"-D__BIG_ENDIAN__=0",
	"-fno-rtti",
	"-fno-exceptions",
	"-fcheck-new",
	"-fpermissive",
	"-static",
	"-g",
	"-nostdinc",
	"-nostdlib",
	"-fno-builtin",
	"-finline",
	"-fno-keep-inline-functions",
	"-msoft-float",
	"-fsigned-bitfields",
	"-Wpointer-arith",
	"-D__i386__",
	"-DPAGE_SIZE_FIXED",
	"-DIOASSERT=0",
	"-DOSALLOCDEBUG=0",
	"-O2",
	"-fschedule-insns",
	"-DAPPLE",
	"-DNeXT",
	"-DKERNEL_PRIVATE",
	"-DDEBUG=0",
	"-D__MACHO__=0",
	"-Dvolatile=__volatile",
	"-DL4IOKIT",
	"-DSLOT_USED=0",
	"-DKERNEL",
	"-DDRIVER_PRIVATE",
	"-Wall",
	"-fno-common",
	"-Wno-multichar",
	"-DIOMATCHDEBUG=1",
	"-DIOALLOCDEBUG=1",
	"-D__STATIC__=1",
	"-w",
	"-fno-strict-aliasing"]
if env.toolchain_name == "apple":
	cxxflags += ["-fapple-kext"]

lib = env.MyLibrary("libkern", 
	LIBS=["libsa", "xnuglue","iguana", "c"], 
	CPPPATH=["#libs/xnuglue/xnu_include/include", 
	"#libs/xnuglue/xnu_include/include/osfmk",  
	"#libs/xnuglue/xnu_include/include/bsd", 
	"#libs/xnuglue/xnu_include/include/EXTERNAL_HEADERS", 
	"#libs/xnuglue/include/xnu_include/pexpert", 
	"#libs/iokit",  
	"#libs/libkern", 
	"#libs/libkern/libsa"], 
	SRCDIR="Kernel", 
	CCFLAGS=["-DXNU_KERNEL_PRIVATE=1",
	"-DTYPE_BOOL=0",
	"-DMACH_ASSERT=0",
	"-DIOASSERT=0",
	"-D__BIG_ENDIAN__=0" ,
	"-D__LITTLE_ENDIAN__=1",
	"-static",
	"-g",
	"-nostdinc",
	"-nostdlib",
	"-fno-builtin",
	"-finline",
	"-fno-keep-inline-functions",
	"-msoft-float",
	"-fsigned-bitfields",
	"-Wpointer-arith",
	"-D__i386__",
	"-DPAGE_SIZE_FIXED",
	"-O2",
	"-fschedule-insns",
	"-DAPPLE",
	"-DNeXT",
	"-DKERNEL_PRIVATE",
	"-D__MACHO__=0",
	"-Dvolatile=__volatile",
	"-DLIBKERN",
	"-DKERNEL",
	"-DLIBKERN_KERNEL_PRIVATE",
	"-DOSALLOCDEBUG=0",
	"-Wall",
	"-fno-common",
	"-Ilibkern",
	"-DKERNEL_PRIVATE",
	"-DL4IOKIT",
	"-D__STATIC__=1",
	"-w",
	"-fno-strict-aliasing"],
	CXXFLAGS=cxxflags,
	source=srcList)
Return("lib")
